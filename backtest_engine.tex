% Created 2018-08-28 二 01:29
% Intended LaTeX compiler: xelatex
\documentclass[11pt]{article}
\usepackage{graphicx}
\usepackage{grffile}
\usepackage{longtable}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{textcomp}
\usepackage{amssymb}
\usepackage{capt-of}
\usepackage{hyperref}
\usepackage{xeCJK}
\usepackage{xcolor}
\usepackage{listings}
\textwidth=6.6in
\textheight=8.9in
\headheight=0.0in
\oddsidemargin=0.0in
\headsep=0.0in
\topmargin=0.0in
\def\baselinestretch{1.3}
\setlength\parindent{0pt}
\lstset{numbers=left,
basicstyle=\linespread{1.0}\small\ttfamily,
numberstyle=\tiny,
keywordstyle= \color{blue!70},commentstyle=\color{red!50!green!50!blue!50},
frame=shadowbox,
rulesepcolor= \color{red!20!green!20!blue!20},
breaklines=true,
backgroundcolor=\color[rgb]{0.91,0.91,0.91},
framextopmargin=2pt,
framexbottommargin=2pt,
abovecaptionskip=-3pt,
belowcaptionskip=3pt,
xleftmargin=0em,
xrightmargin=0em
}
\setCJKmainfont{Songti SC}
\hypersetup{
colorlinks,
linkcolor={red!50!black},
citecolor={blue!50!black},
urlcolor={blue!80!black}
}
\author{liushihao}
\date{\today}
\title{}
\hypersetup{
 pdfauthor={liushihao},
 pdftitle={},
 pdfkeywords={},
 pdfsubject={},
 pdfcreator={Emacs 26.1 (Org mode 9.1.9)}, 
 pdflang={English}}
\begin{document}

\tableofcontents


\section{Download data}
\label{sec:org3f3d670}

\lstset{language=Python,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
import pandas as pd
import math
import ssdata
import matplotlib.pyplot as plt
import numpy as np


###############################################################################
#                           Define framework classes                          #
###############################################################################


class account:
    def __init__(self, start_date, end_date, capital_base, freq, benchmark,
                 universe, tax=0.001, commission=0.00025, slippage=0.01):
        """
        start_date: the start date of back test
        end_date: the end date of back test
        capital_base: initial fund to perform back test
        freq: back test frequencies, measured in days, eg. 1 for daily and 7
            for weekly
        tax: tax rate
        commission: commission rate
        slippage: slippage
        """
        self.start_date = start_date
        self.end_date = end_date
        self.capital_base = capital_base
        self.freq = freq
        self.benchmark = benchmark
        self.universe = universe
        self.tax = tax
        self.commission = commission
        self.slippage = slippage

        self.ini_dic = None
        self.benchmark_data = None
        self.trade_days = None
        self.order_days = None
        self.today_capital = None
        self.ret = None
        self.history_max = None
        self.drawdown_start = None
        self.drawdown_end = None
        self.capital = None
        self.cash = None

    def setup(self):
        self.ini_dic = {}
        self.benchmark_data = pd.DataFrame()

        for stock in self.universe:
            try:
                data = ssdata.get_data(secid=stock,
                                       start_date=self.start_date,
                                       end_date=self.end_date,
                                       field='open,yoyop').dropna().\
                                       sort_index()
                self.ini_dic[stock] = data
                print("Succeed: ", stock, self.universe.index(stock)+1, '/',
                      len(self.universe))
            except Exception:
                print(stock, "data unavailable.", self.universe.index(
                    stock)+1, '/', len(self.universe))

        self.universe = list(self.ini_dic.keys())

        try:
            data = ssdata.get_data(secid=self.benchmark,
                                   start_date=self.start_date,
                                   end_date=self.end_date,
                                   field='open').sort_index().dropna()
            self.benchmark_data = self.benchmark_data.append(data)
        except Exception:
            print("Benchmark ", self.benchmark, " data unavailable.")

        self.trade_days = self.benchmark_data.index
        self.order_days = self.get_order_days()

    def get_order_days(self):
        """
        Return the list of order days based on frequency.
        """
        tdays = list(self.trade_days)
        odays = []
        for i in range(len(tdays)):
            if i % self.freq == 0:
                odays.append(tdays[i])
        return odays


start_date = '2015-07-01'
end_date = '2018-06-01'
capital_base = 1000000
freq = 1
benchmark = ['430002.OC']
universe = list(pd.read_csv("All stocks.csv")['secid'])


account = account(start_date=start_date, end_date=end_date,
                  capital_base=capital_base, freq=freq,
                  benchmark=benchmark, universe=universe)
account.setup()
\end{lstlisting}

\begin{verbatim}
Succeed:  430002.OC 1 / 939
Succeed:  430005.OC 2 / 939
Succeed:  430014.OC 3 / 939
Succeed:  430021.OC 4 / 939
Succeed:  430037.OC 5 / 939
Succeed:  430038.OC 6 / 939
Succeed:  430046.OC 7 / 939
Succeed:  430051.OC 8 / 939
Succeed:  430054.OC 9 / 939
Succeed:  430055.OC 10 / 939
Succeed:  430062.OC 11 / 939
Succeed:  430074.OC 12 / 939
Succeed:  430075.OC 13 / 939
Succeed:  430077.OC 14 / 939
Succeed:  430084.OC 15 / 939
Succeed:  430085.OC 16 / 939
Succeed:  430090.OC 17 / 939
Succeed:  430097.OC 18 / 939
Succeed:  430109.OC 19 / 939
Succeed:  430120.OC 20 / 939
Succeed:  430127.OC 21 / 939
Succeed:  430130.OC 22 / 939
Succeed:  430139.OC 23 / 939
Succeed:  430140.OC 24 / 939
Succeed:  430141.OC 25 / 939
Succeed:  430152.OC 26 / 939
Succeed:  430159.OC 27 / 939
Succeed:  430165.OC 28 / 939
Succeed:  430169.OC 29 / 939
Succeed:  430173.OC 30 / 939
Succeed:  430174.OC 31 / 939
Succeed:  430176.OC 32 / 939
Succeed:  430178.OC 33 / 939
Succeed:  430182.OC 34 / 939
Succeed:  430183.OC 35 / 939
Succeed:  430198.OC 36 / 939
Succeed:  430208.OC 37 / 939
Succeed:  430211.OC 38 / 939
Succeed:  430222.OC 39 / 939
Succeed:  430225.OC 40 / 939
Succeed:  430226.OC 41 / 939
Succeed:  430236.OC 42 / 939
Succeed:  430244.OC 43 / 939
Succeed:  430245.OC 44 / 939
Succeed:  430253.OC 45 / 939
Succeed:  430258.OC 46 / 939
Succeed:  430260.OC 47 / 939
Succeed:  430261.OC 48 / 939
Succeed:  430267.OC 49 / 939
Succeed:  430276.OC 50 / 939
Succeed:  430300.OC 51 / 939
Succeed:  430305.OC 52 / 939
Succeed:  430318.OC 53 / 939
Succeed:  430325.OC 54 / 939
Succeed:  430330.OC 55 / 939
Succeed:  430331.OC 56 / 939
Succeed:  430335.OC 57 / 939
Succeed:  430338.OC 58 / 939
Succeed:  430350.OC 59 / 939
Succeed:  430353.OC 60 / 939
Succeed:  430356.OC 61 / 939
Succeed:  430366.OC 62 / 939
Succeed:  430367.OC 63 / 939
Succeed:  430372.OC 64 / 939
Succeed:  430374.OC 65 / 939
Succeed:  430375.OC 66 / 939
Succeed:  430376.OC 67 / 939
Succeed:  430377.OC 68 / 939
Succeed:  430382.OC 69 / 939
Succeed:  430383.OC 70 / 939
Succeed:  430394.OC 71 / 939
Succeed:  430405.OC 72 / 939
Succeed:  430408.OC 73 / 939
Succeed:  430418.OC 74 / 939
Succeed:  430422.OC 75 / 939
Succeed:  430430.OC 76 / 939
Succeed:  430432.OC 77 / 939
Succeed:  430437.OC 78 / 939
Succeed:  430455.OC 79 / 939
Succeed:  430457.OC 80 / 939
Succeed:  430458.OC 81 / 939
Succeed:  430459.OC 82 / 939
Succeed:  430462.OC 83 / 939
Succeed:  430472.OC 84 / 939
Succeed:  430485.OC 85 / 939
Succeed:  430488.OC 86 / 939
Succeed:  430489.OC 87 / 939
Succeed:  430492.OC 88 / 939
Succeed:  430500.OC 89 / 939
Succeed:  430505.OC 90 / 939
Succeed:  430508.OC 91 / 939
Succeed:  430512.OC 92 / 939
Succeed:  430515.OC 93 / 939
Succeed:  430523.OC 94 / 939
Succeed:  430539.OC 95 / 939
Succeed:  430552.OC 96 / 939
Succeed:  430555.OC 97 / 939
Succeed:  430556.OC 98 / 939
Succeed:  430578.OC 99 / 939
Succeed:  430595.OC 100 / 939
Succeed:  430596.OC 101 / 939
Succeed:  430597.OC 102 / 939
Succeed:  430607.OC 103 / 939
Succeed:  430609.OC 104 / 939
Succeed:  430618.OC 105 / 939
Succeed:  430651.OC 106 / 939
Succeed:  430659.OC 107 / 939
Succeed:  430665.OC 108 / 939
Succeed:  430675.OC 109 / 939
Succeed:  430680.OC 110 / 939
Succeed:  430682.OC 111 / 939
Succeed:  430714.OC 112 / 939
Succeed:  430718.OC 113 / 939
Succeed:  430730.OC 114 / 939
Succeed:  430742.OC 115 / 939
Succeed:  430754.OC 116 / 939
Succeed:  430755.OC 117 / 939
Succeed:  830776.OC 118 / 939
Succeed:  830777.OC 119 / 939
Succeed:  830783.OC 120 / 939
Succeed:  830793.OC 121 / 939
Succeed:  830799.OC 122 / 939
Succeed:  830809.OC 123 / 939
Succeed:  830810.OC 124 / 939
Succeed:  830813.OC 125 / 939
Succeed:  830815.OC 126 / 939
Succeed:  830818.OC 127 / 939
Succeed:  830821.OC 128 / 939
Succeed:  830827.OC 129 / 939
Succeed:  830828.OC 130 / 939
Succeed:  830830.OC 131 / 939
Succeed:  830832.OC 132 / 939
Succeed:  830833.OC 133 / 939
Succeed:  830837.OC 134 / 939
Succeed:  830845.OC 135 / 939
Succeed:  830850.OC 136 / 939
Succeed:  830851.OC 137 / 939
Succeed:  830855.OC 138 / 939
Succeed:  830862.OC 139 / 939
Succeed:  830866.OC 140 / 939
Succeed:  830879.OC 141 / 939
Succeed:  830881.OC 142 / 939
Succeed:  830894.OC 143 / 939
Succeed:  830899.OC 144 / 939
Succeed:  830917.OC 145 / 939
Succeed:  830922.OC 146 / 939
Succeed:  830927.OC 147 / 939
Succeed:  830931.OC 148 / 939
Succeed:  830933.OC 149 / 939
Succeed:  830936.OC 150 / 939
Succeed:  830938.OC 151 / 939
Succeed:  830944.OC 152 / 939
Succeed:  830946.OC 153 / 939
Succeed:  830947.OC 154 / 939
Succeed:  830955.OC 155 / 939
Succeed:  830964.OC 156 / 939
Succeed:  830966.OC 157 / 939
Succeed:  830974.OC 158 / 939
Succeed:  830978.OC 159 / 939
Succeed:  830988.OC 160 / 939
Succeed:  830993.OC 161 / 939
Succeed:  830999.OC 162 / 939
Succeed:  831011.OC 163 / 939
Succeed:  831015.OC 164 / 939
Succeed:  831019.OC 165 / 939
Succeed:  831030.OC 166 / 939
Succeed:  831045.OC 167 / 939
Succeed:  831049.OC 168 / 939
Succeed:  831053.OC 169 / 939
Succeed:  831057.OC 170 / 939
Succeed:  831063.OC 171 / 939
Succeed:  831067.OC 172 / 939
Succeed:  831072.OC 173 / 939
Succeed:  831083.OC 174 / 939
Succeed:  831084.OC 175 / 939
Succeed:  831099.OC 176 / 939
Succeed:  831101.OC 177 / 939
Succeed:  831108.OC 178 / 939
Succeed:  831114.OC 179 / 939
Succeed:  831126.OC 180 / 939
Succeed:  831129.OC 181 / 939
Succeed:  831140.OC 182 / 939
Succeed:  831142.OC 183 / 939
Succeed:  831149.OC 184 / 939
Succeed:  831152.OC 185 / 939
Succeed:  831159.OC 186 / 939
Succeed:  831161.OC 187 / 939
Succeed:  831162.OC 188 / 939
Succeed:  831173.OC 189 / 939
Succeed:  831175.OC 190 / 939
Succeed:  831177.OC 191 / 939
Succeed:  831186.OC 192 / 939
Succeed:  831187.OC 193 / 939
Succeed:  831194.OC 194 / 939
Succeed:  831207.OC 195 / 939
Succeed:  831235.OC 196 / 939
Succeed:  831242.OC 197 / 939
Succeed:  831243.OC 198 / 939
Succeed:  831248.OC 199 / 939
Succeed:  831253.OC 200 / 939
Succeed:  831274.OC 201 / 939
Succeed:  831276.OC 202 / 939
Succeed:  831278.OC 203 / 939
Succeed:  831287.OC 204 / 939
Succeed:  831289.OC 205 / 939
Succeed:  831299.OC 206 / 939
Succeed:  831305.OC 207 / 939
Succeed:  831306.OC 208 / 939
Succeed:  831311.OC 209 / 939
Succeed:  831315.OC 210 / 939
Succeed:  831327.OC 211 / 939
Succeed:  831330.OC 212 / 939
Succeed:  831343.OC 213 / 939
Succeed:  831344.OC 214 / 939
Succeed:  831345.OC 215 / 939
Succeed:  831353.OC 216 / 939
Succeed:  831354.OC 217 / 939
Succeed:  831355.OC 218 / 939
Succeed:  831367.OC 219 / 939
Succeed:  831370.OC 220 / 939
Succeed:  831378.OC 221 / 939
Succeed:  831385.OC 222 / 939
Succeed:  831386.OC 223 / 939
Succeed:  831392.OC 224 / 939
Succeed:  831417.OC 225 / 939
Succeed:  831439.OC 226 / 939
Succeed:  831450.OC 227 / 939
Succeed:  831472.OC 228 / 939
Succeed:  831475.OC 229 / 939
Succeed:  831484.OC 230 / 939
Succeed:  831486.OC 231 / 939
Succeed:  831496.OC 232 / 939
Succeed:  831511.OC 233 / 939
Succeed:  831512.OC 234 / 939
Succeed:  831513.OC 235 / 939
Succeed:  831529.OC 236 / 939
Succeed:  831533.OC 237 / 939
Succeed:  831546.OC 238 / 939
Succeed:  831550.OC 239 / 939
Succeed:  831557.OC 240 / 939
Succeed:  831558.OC 241 / 939
Succeed:  831562.OC 242 / 939
Succeed:  831565.OC 243 / 939
Succeed:  831566.OC 244 / 939
Succeed:  831568.OC 245 / 939
Succeed:  831576.OC 246 / 939
Succeed:  831583.OC 247 / 939
Succeed:  831595.OC 248 / 939
Succeed:  831601.OC 249 / 939
Succeed:  831603.OC 250 / 939
Succeed:  831609.OC 251 / 939
Succeed:  831614.OC 252 / 939
Succeed:  831626.OC 253 / 939
Succeed:  831628.OC 254 / 939
Succeed:  831633.OC 255 / 939
Succeed:  831635.OC 256 / 939
Succeed:  831640.OC 257 / 939
Succeed:  831663.OC 258 / 939
Succeed:  831672.OC 259 / 939
Succeed:  831675.OC 260 / 939
Succeed:  831688.OC 261 / 939
Succeed:  831697.OC 262 / 939
Succeed:  831698.OC 263 / 939
Succeed:  831701.OC 264 / 939
Succeed:  831706.OC 265 / 939
Succeed:  831709.OC 266 / 939
Succeed:  831710.OC 267 / 939
Succeed:  831711.OC 268 / 939
Succeed:  831718.OC 269 / 939
Succeed:  831725.OC 270 / 939
Succeed:  831728.OC 271 / 939
Succeed:  831729.OC 272 / 939
Succeed:  831742.OC 273 / 939
Succeed:  831743.OC 274 / 939
Succeed:  831776.OC 275 / 939
Succeed:  831829.OC 276 / 939
Succeed:  831839.OC 277 / 939
Succeed:  831844.OC 278 / 939
Succeed:  831852.OC 279 / 939
Succeed:  831866.OC 280 / 939
Succeed:  831873.OC 281 / 939
Succeed:  831885.OC 282 / 939
Succeed:  831888.OC 283 / 939
Succeed:  831890.OC 284 / 939
Succeed:  831900.OC 285 / 939
Succeed:  831913.OC 286 / 939
Succeed:  831925.OC 287 / 939
Succeed:  831929.OC 288 / 939
Succeed:  831930.OC 289 / 939
Succeed:  831940.OC 290 / 939
Succeed:  831943.OC 291 / 939
Succeed:  831961.OC 292 / 939
Succeed:  831971.OC 293 / 939
Succeed:  831972.OC 294 / 939
Succeed:  831981.OC 295 / 939
Succeed:  831984.OC 296 / 939
Succeed:  831988.OC 297 / 939
Succeed:  831999.OC 298 / 939
Succeed:  832003.OC 299 / 939
Succeed:  832007.OC 300 / 939
Succeed:  832014.OC 301 / 939
Succeed:  832026.OC 302 / 939
Succeed:  832028.OC 303 / 939
Succeed:  832041.OC 304 / 939
Succeed:  832047.OC 305 / 939
Succeed:  832060.OC 306 / 939
Succeed:  832063.OC 307 / 939
Succeed:  832075.OC 308 / 939
Succeed:  832080.OC 309 / 939
Succeed:  832081.OC 310 / 939
Succeed:  832086.OC 311 / 939
Succeed:  832093.OC 312 / 939
Succeed:  832094.OC 313 / 939
Succeed:  832107.OC 314 / 939
Succeed:  832108.OC 315 / 939
Succeed:  832110.OC 316 / 939
Succeed:  832120.OC 317 / 939
Succeed:  832123.OC 318 / 939
Succeed:  832126.OC 319 / 939
Succeed:  832127.OC 320 / 939
Succeed:  832132.OC 321 / 939
Succeed:  832133.OC 322 / 939
Succeed:  832134.OC 323 / 939
Succeed:  832135.OC 324 / 939
Succeed:  832136.OC 325 / 939
Succeed:  832139.OC 326 / 939
Succeed:  832149.OC 327 / 939
Succeed:  832151.OC 328 / 939
Succeed:  832159.OC 329 / 939
Succeed:  832167.OC 330 / 939
Succeed:  832172.OC 331 / 939
Succeed:  832175.OC 332 / 939
Succeed:  832178.OC 333 / 939
Succeed:  832184.OC 334 / 939
Succeed:  832188.OC 335 / 939
Succeed:  832196.OC 336 / 939
Succeed:  832201.OC 337 / 939
Succeed:  832213.OC 338 / 939
Succeed:  832214.OC 339 / 939
Succeed:  832218.OC 340 / 939
Succeed:  832221.OC 341 / 939
Succeed:  832230.OC 342 / 939
Succeed:  832236.OC 343 / 939
Succeed:  832246.OC 344 / 939
Succeed:  832255.OC 345 / 939
Succeed:  832258.OC 346 / 939
Succeed:  832265.OC 347 / 939
Succeed:  832276.OC 348 / 939
Succeed:  832278.OC 349 / 939
Succeed:  832280.OC 350 / 939
Succeed:  832281.OC 351 / 939
Succeed:  832283.OC 352 / 939
Succeed:  832297.OC 353 / 939
Succeed:  832303.OC 354 / 939
Succeed:  832308.OC 355 / 939
Succeed:  832316.OC 356 / 939
Succeed:  832317.OC 357 / 939
Succeed:  832320.OC 358 / 939
Succeed:  832325.OC 359 / 939
Succeed:  832327.OC 360 / 939
Succeed:  832329.OC 361 / 939
Succeed:  832340.OC 362 / 939
Succeed:  832353.OC 363 / 939
Succeed:  832354.OC 364 / 939
Succeed:  832359.OC 365 / 939
Succeed:  832390.OC 366 / 939
Succeed:  832397.OC 367 / 939
Succeed:  832398.OC 368 / 939
Succeed:  832399.OC 369 / 939
Succeed:  832404.OC 370 / 939
Succeed:  832412.OC 371 / 939
Succeed:  832422.OC 372 / 939
Succeed:  832432.OC 373 / 939
Succeed:  832444.OC 374 / 939
Succeed:  832449.OC 375 / 939
Succeed:  832452.OC 376 / 939
Succeed:  832453.OC 377 / 939
Succeed:  832455.OC 378 / 939
Succeed:  832462.OC 379 / 939
Succeed:  832467.OC 380 / 939
Succeed:  832469.OC 381 / 939
Succeed:  832482.OC 382 / 939
Succeed:  832491.OC 383 / 939
Succeed:  832499.OC 384 / 939
Succeed:  832511.OC 385 / 939
Succeed:  832522.OC 386 / 939
Succeed:  832532.OC 387 / 939
Succeed:  832533.OC 388 / 939
Succeed:  832540.OC 389 / 939
Succeed:  832555.OC 390 / 939
Succeed:  832559.OC 391 / 939
Succeed:  832562.OC 392 / 939
Succeed:  832563.OC 393 / 939
Succeed:  832566.OC 394 / 939
Succeed:  832571.OC 395 / 939
Succeed:  832579.OC 396 / 939
Succeed:  832580.OC 397 / 939
Succeed:  832585.OC 398 / 939
Succeed:  832586.OC 399 / 939
Succeed:  832588.OC 400 / 939
Succeed:  832597.OC 401 / 939
Succeed:  832602.OC 402 / 939
Succeed:  832616.OC 403 / 939
Succeed:  832620.OC 404 / 939
Succeed:  832638.OC 405 / 939
Succeed:  832641.OC 406 / 939
Succeed:  832645.OC 407 / 939
Succeed:  832646.OC 408 / 939
Succeed:  832666.OC 409 / 939
Succeed:  832693.OC 410 / 939
Succeed:  832705.OC 411 / 939
Succeed:  832707.OC 412 / 939
Succeed:  832735.OC 413 / 939
Succeed:  832763.OC 414 / 939
Succeed:  832768.OC 415 / 939
Succeed:  832773.OC 416 / 939
Succeed:  832774.OC 417 / 939
Succeed:  832783.OC 418 / 939
Succeed:  832786.OC 419 / 939
Succeed:  832792.OC 420 / 939
Succeed:  832800.OC 421 / 939
Succeed:  832802.OC 422 / 939
Succeed:  832814.OC 423 / 939
Succeed:  832821.OC 424 / 939
Succeed:  832840.OC 425 / 939
Succeed:  832850.OC 426 / 939
Succeed:  832854.OC 427 / 939
Succeed:  832859.OC 428 / 939
Succeed:  832873.OC 429 / 939
Succeed:  832881.OC 430 / 939
Succeed:  832893.OC 431 / 939
Succeed:  832896.OC 432 / 939
Succeed:  832898.OC 433 / 939
Succeed:  832899.OC 434 / 939
Succeed:  832902.OC 435 / 939
Succeed:  832910.OC 436 / 939
Succeed:  832918.OC 437 / 939
Succeed:  832927.OC 438 / 939
Succeed:  832929.OC 439 / 939
Succeed:  832938.OC 440 / 939
Succeed:  832950.OC 441 / 939
Succeed:  832953.OC 442 / 939
Succeed:  832958.OC 443 / 939
Succeed:  832959.OC 444 / 939
Succeed:  832960.OC 445 / 939
Succeed:  832966.OC 446 / 939
Succeed:  832971.OC 447 / 939
Succeed:  832973.OC 448 / 939
Succeed:  832974.OC 449 / 939
Succeed:  832975.OC 450 / 939
Succeed:  832978.OC 451 / 939
Succeed:  832982.OC 452 / 939
Succeed:  833014.OC 453 / 939
Succeed:  833029.OC 454 / 939
Succeed:  833037.OC 455 / 939
Succeed:  833041.OC 456 / 939
Succeed:  833047.OC 457 / 939
Succeed:  833057.OC 458 / 939
Succeed:  833066.OC 459 / 939
Succeed:  833099.OC 460 / 939
Succeed:  833105.OC 461 / 939
Succeed:  833132.OC 462 / 939
Succeed:  833146.OC 463 / 939
Succeed:  833147.OC 464 / 939
Succeed:  833158.OC 465 / 939
Succeed:  833159.OC 466 / 939
Succeed:  833160.OC 467 / 939
Succeed:  833182.OC 468 / 939
Succeed:  833183.OC 469 / 939
Succeed:  833186.OC 470 / 939
Succeed:  833197.OC 471 / 939
Succeed:  833222.OC 472 / 939
Succeed:  833224.OC 473 / 939
Succeed:  833255.OC 474 / 939
Succeed:  833266.OC 475 / 939
Succeed:  833278.OC 476 / 939
Succeed:  833284.OC 477 / 939
Succeed:  833288.OC 478 / 939
Succeed:  833292.OC 479 / 939
Succeed:  833295.OC 480 / 939
Succeed:  833300.OC 481 / 939
Succeed:  833308.OC 482 / 939
Succeed:  833311.OC 483 / 939
Succeed:  833330.OC 484 / 939
Succeed:  833331.OC 485 / 939
Succeed:  833339.OC 486 / 939
Succeed:  833341.OC 487 / 939
Succeed:  833355.OC 488 / 939
Succeed:  833366.OC 489 / 939
Succeed:  833371.OC 490 / 939
Succeed:  833374.OC 491 / 939
Succeed:  833379.OC 492 / 939
Succeed:  833382.OC 493 / 939
Succeed:  833414.OC 494 / 939
Succeed:  833423.OC 495 / 939
Succeed:  833426.OC 496 / 939
Succeed:  833442.OC 497 / 939
Succeed:  833448.OC 498 / 939
Succeed:  833449.OC 499 / 939
Succeed:  833451.OC 500 / 939
Succeed:  833466.OC 501 / 939
Succeed:  833482.OC 502 / 939
Succeed:  833493.OC 503 / 939
Succeed:  833497.OC 504 / 939
Succeed:  833503.OC 505 / 939
Succeed:  833506.OC 506 / 939
Succeed:  833517.OC 507 / 939
Succeed:  833528.OC 508 / 939
Succeed:  833529.OC 509 / 939
Succeed:  833532.OC 510 / 939
Succeed:  833533.OC 511 / 939
Succeed:  833553.OC 512 / 939
Succeed:  833559.OC 513 / 939
Succeed:  833581.OC 514 / 939
Succeed:  833619.OC 515 / 939
Succeed:  833623.OC 516 / 939
Succeed:  833624.OC 517 / 939
Succeed:  833627.OC 518 / 939
Succeed:  833629.OC 519 / 939
Succeed:  833631.OC 520 / 939
Succeed:  833644.OC 521 / 939
Succeed:  833653.OC 522 / 939
Succeed:  833654.OC 523 / 939
Succeed:  833656.OC 524 / 939
Succeed:  833658.OC 525 / 939
Succeed:  833659.OC 526 / 939
Succeed:  833662.OC 527 / 939
Succeed:  833682.OC 528 / 939
Succeed:  833684.OC 529 / 939
Succeed:  833694.OC 530 / 939
Succeed:  833722.OC 531 / 939
Succeed:  833742.OC 532 / 939
Succeed:  833743.OC 533 / 939
Succeed:  833755.OC 534 / 939
Succeed:  833757.OC 535 / 939
Succeed:  833767.OC 536 / 939
Succeed:  833770.OC 537 / 939
Succeed:  833790.OC 538 / 939
Succeed:  833796.OC 539 / 939
Succeed:  833819.OC 540 / 939
Succeed:  833827.OC 541 / 939
Succeed:  833833.OC 542 / 939
Succeed:  833840.OC 543 / 939
Succeed:  833856.OC 544 / 939
Succeed:  833874.OC 545 / 939
Succeed:  833881.OC 546 / 939
Succeed:  833896.OC 547 / 939
Succeed:  833913.OC 548 / 939
Succeed:  833914.OC 549 / 939
Succeed:  833954.OC 550 / 939
Succeed:  833960.OC 551 / 939
Succeed:  833972.OC 552 / 939
Succeed:  833994.OC 553 / 939
Succeed:  833997.OC 554 / 939
Succeed:  834013.OC 555 / 939
Succeed:  834019.OC 556 / 939
Succeed:  834020.OC 557 / 939
Succeed:  834021.OC 558 / 939
Succeed:  834023.OC 559 / 939
Succeed:  834070.OC 560 / 939
Succeed:  834082.OC 561 / 939
Succeed:  834084.OC 562 / 939
Succeed:  834102.OC 563 / 939
Succeed:  834122.OC 564 / 939
Succeed:  834126.OC 565 / 939
Succeed:  834134.OC 566 / 939
Succeed:  834153.OC 567 / 939
Succeed:  834154.OC 568 / 939
Succeed:  834156.OC 569 / 939
Succeed:  834178.OC 570 / 939
Succeed:  834179.OC 571 / 939
Succeed:  834187.OC 572 / 939
Succeed:  834195.OC 573 / 939
Succeed:  834203.OC 574 / 939
Succeed:  834206.OC 575 / 939
Succeed:  834209.OC 576 / 939
Succeed:  834222.OC 577 / 939
Succeed:  834240.OC 578 / 939
Succeed:  834255.OC 579 / 939
Succeed:  834262.OC 580 / 939
Succeed:  834270.OC 581 / 939
Succeed:  834303.OC 582 / 939
Succeed:  834342.OC 583 / 939
Succeed:  834365.OC 584 / 939
Succeed:  834385.OC 585 / 939
Succeed:  834415.OC 586 / 939
Succeed:  834425.OC 587 / 939
Succeed:  834428.OC 588 / 939
Succeed:  834438.OC 589 / 939
Succeed:  834440.OC 590 / 939
Succeed:  834474.OC 591 / 939
Succeed:  834475.OC 592 / 939
Succeed:  834476.OC 593 / 939
Succeed:  834489.OC 594 / 939
Succeed:  834496.OC 595 / 939
Succeed:  834498.OC 596 / 939
Succeed:  834507.OC 597 / 939
Succeed:  834509.OC 598 / 939
Succeed:  834534.OC 599 / 939
Succeed:  834549.OC 600 / 939
Succeed:  834568.OC 601 / 939
Succeed:  834598.OC 602 / 939
Succeed:  834616.OC 603 / 939
Succeed:  834618.OC 604 / 939
Succeed:  834620.OC 605 / 939
Succeed:  834631.OC 606 / 939
Succeed:  834641.OC 607 / 939
Succeed:  834653.OC 608 / 939
Succeed:  834678.OC 609 / 939
Succeed:  834680.OC 610 / 939
Succeed:  834682.OC 611 / 939
Succeed:  834683.OC 612 / 939
Succeed:  834687.OC 613 / 939
Succeed:  834695.OC 614 / 939
Succeed:  834698.OC 615 / 939
Succeed:  834707.OC 616 / 939
Succeed:  834713.OC 617 / 939
Succeed:  834720.OC 618 / 939
Succeed:  834729.OC 619 / 939
Succeed:  834732.OC 620 / 939
Succeed:  834742.OC 621 / 939
Succeed:  834761.OC 622 / 939
Succeed:  834762.OC 623 / 939
Succeed:  834765.OC 624 / 939
Succeed:  834767.OC 625 / 939
Succeed:  834770.OC 626 / 939
Succeed:  834771.OC 627 / 939
Succeed:  834772.OC 628 / 939
Succeed:  834791.OC 629 / 939
Succeed:  834793.OC 630 / 939
Succeed:  834802.OC 631 / 939
Succeed:  834803.OC 632 / 939
Succeed:  834817.OC 633 / 939
Succeed:  834825.OC 634 / 939
Succeed:  834832.OC 635 / 939
Succeed:  834845.OC 636 / 939
Succeed:  834857.OC 637 / 939
Succeed:  834874.OC 638 / 939
Succeed:  834877.OC 639 / 939
Succeed:  834887.OC 640 / 939
Succeed:  834898.OC 641 / 939
Succeed:  834980.OC 642 / 939
Succeed:  834984.OC 643 / 939
Succeed:  834996.OC 644 / 939
Succeed:  835002.OC 645 / 939
Succeed:  835003.OC 646 / 939
Succeed:  835021.OC 647 / 939
Succeed:  835024.OC 648 / 939
Succeed:  835032.OC 649 / 939
Succeed:  835033.OC 650 / 939
Succeed:  835035.OC 651 / 939
Succeed:  835092.OC 652 / 939
Succeed:  835093.OC 653 / 939
Succeed:  835145.OC 654 / 939
Succeed:  835181.OC 655 / 939
Succeed:  835184.OC 656 / 939
Succeed:  835185.OC 657 / 939
Succeed:  835192.OC 658 / 939
Succeed:  835197.OC 659 / 939
Succeed:  835212.OC 660 / 939
Succeed:  835217.OC 661 / 939
Succeed:  835259.OC 662 / 939
Succeed:  835265.OC 663 / 939
Succeed:  835296.OC 664 / 939
Succeed:  835298.OC 665 / 939
Succeed:  835300.OC 666 / 939
Succeed:  835322.OC 667 / 939
Succeed:  835348.OC 668 / 939
Succeed:  835359.OC 669 / 939
Succeed:  835368.OC 670 / 939
Succeed:  835381.OC 671 / 939
Succeed:  835387.OC 672 / 939
Succeed:  835401.OC 673 / 939
Succeed:  835414.OC 674 / 939
Succeed:  835425.OC 675 / 939
Succeed:  835474.OC 676 / 939
Succeed:  835483.OC 677 / 939
Succeed:  835505.OC 678 / 939
Succeed:  835508.OC 679 / 939
Succeed:  835538.OC 680 / 939
Succeed:  835557.OC 681 / 939
Succeed:  835572.OC 682 / 939
Succeed:  835577.OC 683 / 939
Succeed:  835611.OC 684 / 939
Succeed:  835654.OC 685 / 939
Succeed:  835663.OC 686 / 939
Succeed:  835710.OC 687 / 939
Succeed:  835787.OC 688 / 939
Succeed:  835842.OC 689 / 939
Succeed:  835850.OC 690 / 939
Succeed:  835859.OC 691 / 939
Succeed:  835860.OC 692 / 939
Succeed:  835902.OC 693 / 939
Succeed:  835911.OC 694 / 939
Succeed:  835955.OC 695 / 939
Succeed:  835959.OC 696 / 939
Succeed:  835961.OC 697 / 939
Succeed:  835990.OC 698 / 939
Succeed:  835995.OC 699 / 939
Succeed:  836030.OC 700 / 939
Succeed:  836042.OC 701 / 939
Succeed:  836052.OC 702 / 939
Succeed:  836053.OC 703 / 939
Succeed:  836066.OC 704 / 939
Succeed:  836081.OC 705 / 939
Succeed:  836093.OC 706 / 939
Succeed:  836108.OC 707 / 939
Succeed:  836116.OC 708 / 939
Succeed:  836129.OC 709 / 939
Succeed:  836149.OC 710 / 939
Succeed:  836183.OC 711 / 939
Succeed:  836190.OC 712 / 939
Succeed:  836200.OC 713 / 939
Succeed:  836232.OC 714 / 939
Succeed:  836263.OC 715 / 939
Succeed:  836267.OC 716 / 939
Succeed:  836330.OC 717 / 939
Succeed:  836346.OC 718 / 939
Succeed:  836433.OC 719 / 939
Succeed:  836437.OC 720 / 939
Succeed:  836455.OC 721 / 939
Succeed:  836460.OC 722 / 939
Succeed:  836473.OC 723 / 939
Succeed:  836529.OC 724 / 939
Succeed:  836559.OC 725 / 939
Succeed:  836583.OC 726 / 939
Succeed:  836589.OC 727 / 939
Succeed:  836610.OC 728 / 939
Succeed:  836617.OC 729 / 939
Succeed:  836625.OC 730 / 939
Succeed:  836645.OC 731 / 939
Succeed:  836675.OC 732 / 939
Succeed:  836686.OC 733 / 939
Succeed:  836689.OC 734 / 939
Succeed:  836690.OC 735 / 939
Succeed:  836703.OC 736 / 939
Succeed:  836708.OC 737 / 939
Succeed:  836709.OC 738 / 939
Succeed:  836728.OC 739 / 939
Succeed:  836734.OC 740 / 939
Succeed:  836792.OC 741 / 939
Succeed:  836800.OC 742 / 939
Succeed:  836801.OC 743 / 939
Succeed:  836813.OC 744 / 939
Succeed:  836859.OC 745 / 939
Succeed:  836870.OC 746 / 939
Succeed:  836875.OC 747 / 939
Succeed:  836899.OC 748 / 939
Succeed:  836916.OC 749 / 939
Succeed:  836989.OC 750 / 939
Succeed:  837022.OC 751 / 939
Succeed:  837092.OC 752 / 939
Succeed:  837097.OC 753 / 939
Succeed:  837128.OC 754 / 939
Succeed:  837138.OC 755 / 939
Succeed:  837160.OC 756 / 939
Succeed:  837181.OC 757 / 939
Succeed:  837183.OC 758 / 939
Succeed:  837193.OC 759 / 939
Succeed:  837249.OC 760 / 939
Succeed:  837293.OC 761 / 939
Succeed:  837299.OC 762 / 939
Succeed:  837321.OC 763 / 939
Succeed:  837331.OC 764 / 939
Succeed:  837348.OC 765 / 939
Succeed:  837353.OC 766 / 939
Succeed:  837424.OC 767 / 939
Succeed:  837443.OC 768 / 939
Succeed:  837449.OC 769 / 939
Succeed:  837472.OC 770 / 939
Succeed:  837498.OC 771 / 939
Succeed:  837500.OC 772 / 939
Succeed:  837558.OC 773 / 939
Succeed:  837567.OC 774 / 939
Succeed:  837610.OC 775 / 939
Succeed:  837628.OC 776 / 939
Succeed:  837665.OC 777 / 939
Succeed:  837673.OC 778 / 939
Succeed:  837674.OC 779 / 939
Succeed:  837689.OC 780 / 939
Succeed:  837729.OC 781 / 939
Succeed:  837747.OC 782 / 939
Succeed:  837761.OC 783 / 939
Succeed:  837770.OC 784 / 939
Succeed:  837796.OC 785 / 939
Succeed:  837797.OC 786 / 939
Succeed:  837932.OC 787 / 939
Succeed:  837935.OC 788 / 939
Succeed:  837939.OC 789 / 939
Succeed:  837953.OC 790 / 939
Succeed:  838006.OC 791 / 939
Succeed:  838030.OC 792 / 939
Succeed:  838053.OC 793 / 939
Succeed:  838104.OC 794 / 939
Succeed:  838115.OC 795 / 939
Succeed:  838123.OC 796 / 939
Succeed:  838154.OC 797 / 939
Succeed:  838163.OC 798 / 939
Succeed:  838210.OC 799 / 939
Succeed:  838220.OC 800 / 939
Succeed:  838257.OC 801 / 939
Succeed:  838265.OC 802 / 939
Succeed:  838317.OC 803 / 939
Succeed:  838324.OC 804 / 939
Succeed:  838349.OC 805 / 939
Succeed:  838357.OC 806 / 939
Succeed:  838384.OC 807 / 939
Succeed:  838413.OC 808 / 939
Succeed:  838428.OC 809 / 939
Succeed:  838483.OC 810 / 939
Succeed:  838484.OC 811 / 939
Succeed:  838504.OC 812 / 939
Succeed:  838517.OC 813 / 939
Succeed:  838526.OC 814 / 939
Succeed:  838535.OC 815 / 939
Succeed:  838564.OC 816 / 939
Succeed:  838570.OC 817 / 939
Succeed:  838593.OC 818 / 939
Succeed:  838641.OC 819 / 939
Succeed:  838650.OC 820 / 939
Succeed:  838659.OC 821 / 939
Succeed:  838696.OC 822 / 939
Succeed:  838777.OC 823 / 939
Succeed:  838810.OC 824 / 939
Succeed:  838823.OC 825 / 939
Succeed:  838827.OC 826 / 939
Succeed:  838830.OC 827 / 939
Succeed:  838843.OC 828 / 939
Succeed:  838849.OC 829 / 939
Succeed:  838924.OC 830 / 939
Succeed:  838943.OC 831 / 939
Succeed:  838944.OC 832 / 939
Succeed:  838974.OC 833 / 939
Succeed:  838984.OC 834 / 939
Succeed:  839056.OC 835 / 939
Succeed:  839074.OC 836 / 939
Succeed:  839123.OC 837 / 939
Succeed:  839133.OC 838 / 939
Succeed:  839135.OC 839 / 939
Succeed:  839149.OC 840 / 939
Succeed:  839167.OC 841 / 939
Succeed:  839202.OC 842 / 939
Succeed:  839205.OC 843 / 939
Succeed:  839230.OC 844 / 939
Succeed:  839242.OC 845 / 939
Succeed:  839258.OC 846 / 939
Succeed:  839264.OC 847 / 939
Succeed:  839271.OC 848 / 939
Succeed:  839275.OC 849 / 939
Succeed:  839281.OC 850 / 939
Succeed:  839284.OC 851 / 939
Succeed:  839295.OC 852 / 939
Succeed:  839296.OC 853 / 939
Succeed:  839306.OC 854 / 939
Succeed:  839316.OC 855 / 939
Succeed:  839373.OC 856 / 939
Succeed:  839411.OC 857 / 939
Succeed:  839456.OC 858 / 939
Succeed:  839483.OC 859 / 939
Succeed:  839484.OC 860 / 939
Succeed:  839505.OC 861 / 939
Succeed:  839603.OC 862 / 939
Succeed:  839639.OC 863 / 939
Succeed:  839646.OC 864 / 939
Succeed:  839695.OC 865 / 939
Succeed:  839697.OC 866 / 939
Succeed:  839712.OC 867 / 939
Succeed:  839719.OC 868 / 939
Succeed:  839729.OC 869 / 939
Succeed:  839737.OC 870 / 939
Succeed:  839797.OC 871 / 939
Succeed:  839798.OC 872 / 939
Succeed:  839805.OC 873 / 939
Succeed:  839816.OC 874 / 939
Succeed:  839878.OC 875 / 939
Succeed:  839884.OC 876 / 939
Succeed:  839930.OC 877 / 939
Succeed:  839951.OC 878 / 939
Succeed:  870009.OC 879 / 939
Succeed:  870035.OC 880 / 939
Succeed:  870040.OC 881 / 939
Succeed:  870049.OC 882 / 939
Succeed:  870147.OC 883 / 939
Succeed:  870162.OC 884 / 939
Succeed:  870170.OC 885 / 939
Succeed:  870177.OC 886 / 939
Succeed:  870190.OC 887 / 939
Succeed:  870229.OC 888 / 939
Succeed:  870231.OC 889 / 939
Succeed:  870239.OC 890 / 939
Succeed:  870257.OC 891 / 939
Succeed:  870259.OC 892 / 939
Succeed:  870270.OC 893 / 939
Succeed:  870309.OC 894 / 939
Succeed:  870336.OC 895 / 939
Succeed:  870338.OC 896 / 939
Succeed:  870361.OC 897 / 939
Succeed:  870387.OC 898 / 939
Succeed:  870399.OC 899 / 939
Succeed:  870409.OC 900 / 939
Succeed:  870490.OC 901 / 939
Succeed:  870510.OC 902 / 939
Succeed:  870552.OC 903 / 939
Succeed:  870614.OC 904 / 939
Succeed:  870643.OC 905 / 939
Succeed:  870706.OC 906 / 939
Succeed:  870714.OC 907 / 939
Succeed:  870725.OC 908 / 939
Succeed:  870773.OC 909 / 939
Succeed:  870812.OC 910 / 939
Succeed:  870844.OC 911 / 939
Succeed:  870984.OC 912 / 939
Succeed:  870997.OC 913 / 939
Succeed:  870998.OC 914 / 939
Succeed:  871042.OC 915 / 939
Succeed:  871082.OC 916 / 939
Succeed:  871177.OC 917 / 939
Succeed:  871195.OC 918 / 939
Succeed:  871224.OC 919 / 939
Succeed:  871326.OC 920 / 939
Succeed:  871348.OC 921 / 939
Succeed:  871370.OC 922 / 939
Succeed:  871396.OC 923 / 939
Succeed:  871481.OC 924 / 939
Succeed:  871543.OC 925 / 939
Succeed:  871642.OC 926 / 939
Succeed:  871655.OC 927 / 939
Succeed:  871703.OC 928 / 939
Succeed:  872034.OC 929 / 939
Succeed:  872049.OC 930 / 939
Succeed:  872087.OC 931 / 939
Succeed:  872149.OC 932 / 939
Succeed:  872186.OC 933 / 939
Succeed:  872210.OC 934 / 939
Succeed:  872242.OC 935 / 939
Succeed:  872351.OC 936 / 939
Succeed:  872358.OC 937 / 939
Succeed:  872440.OC 938 / 939
Succeed:  872627.OC 939 / 939
\end{verbatim}


\section{Trade}
\label{sec:org3ca98e6}

\lstset{language=Python,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
%matplotlib inline
account.today_capital = None
# 存储收益情况的dataframe，索引是日期，列有策略收益率、基准收益率、最大回撤、
# 最大回撤区间
account.ret = None
# 历史最大回撤
account.history_max = None
# 历史最大回撤区间起始日
account.drawdown_start = None
# 历史最大回撤区间终止日
account.drawdown_end = None
# 存储每个交易日总资产的列表
account.capital = None
# 现金
account.cash = None

account.ret = pd.DataFrame()
account.history_max = 0
account.capital = []
account.cash = account.capital_base


h_amount = pd.DataFrame({'hamount': [0],
                         'price': [0],
                         'value': [0],
                         'percent': [0]}, index=account.universe)
selected = pd.DataFrame()


def order_to(target):
    """
    下单到多少股。
    """
    global h_amount
    trade_days = account.trade_days
    order_days = account.order_days
    tax = account.tax
    commission = account.commission
    ini_dic = account.ini_dic
    today_capital = account.today_capital
    slippage = account.slippage

    # 如果date在下单日，就需要进行调仓
    if date in order_days:
        # print(date.strftime('%Y-%m-%d'), list(target.index))
        # t_amount是目标仓位数据的dataframe
        t_amount = pd.DataFrame({'tamount': [0]}, index=list(target.index))

        # Sell stocks in holding but not in target
        for stock in list(h_amount.index):
            if stock not in list(target.index):
                try:
                    stock_data = ini_dic[stock].loc[date.strftime("%Y-%m-%d")]
                    price = stock_data['open']
                    account.cash += h_amount.loc[stock, 'hamount'] *\
                        (price-slippage) * (1-tax-commission)
                    print('order: ', stock, 'amount ',
                          int(0-h_amount.loc[stock, 'hamount']))
                    h_amount.loc[stock, 'hamount'] = -1
                except Exception:
                    h_amount.loc[stock, 'hamount'] = -1
        h_amount = h_amount[h_amount['hamount'] != -1]
        # print("cash: ", account.cash)

        # Deal with stocks in target
        for stock in list(target.index):
            stock_data = ini_dic[stock].loc[date.strftime(
                "%Y-%m-%d")].fillna(0)
            price = stock_data['open']
            # price = stock_data.loc[date.strftime('%Y-%m-%d'), 'open']

            # Buy stocks in target but not in holding
            if stock not in list(h_amount.index):
                h_amount = h_amount.append(pd.DataFrame({'hamount': [0],
                                                         'price': [0],
                                                         'value': [0],
                                                         'percent': [0]},
                                                        index=[stock]))
            # print(target)
            t_amount.loc[stock, 'tamount'] = math.floor(target[stock]/100)*100

            # If hoding > target, sell
            if h_amount.loc[stock, 'hamount'] - t_amount.loc[stock, 'tamount']\
               > 0:
                account.cash += (h_amount.loc[stock, 'hamount'] -
                                 t_amount.loc[stock, 'tamount'])\
                                 * (price-slippage) * (1-tax-commission)

            # If hoding < target, buy
            if h_amount.loc[stock, 'hamount'] - t_amount.loc[stock, 'tamount']\
               < 0:
                # Attention: buy hand by hand in case cash becomes negative
                for number in range(int(t_amount.loc[stock, 'tamount']/100),
                                    0, -1):
                    if account.cash - (number*100 -
                                       h_amount.loc[stock, 'hamount']) *\
                                       (price+slippage) * (1+commission) < 0:
                        continue
                    else:
                        account.cash -= (number*100 -
                                         h_amount.loc[stock, 'hamount']) *\
                                         (price+slippage) * (1+commission)
                        t_amount.loc[stock, 'tamount'] = number * 100
                        break

            if h_amount.loc[stock, 'hamount'] - t_amount.loc[stock, 'tamount']\
               != 0:
                print('order: ', stock, 'amount ',
                      int(t_amount.loc[stock, 'tamount'] -
                          h_amount.loc[stock, 'hamount']))

            h_amount.loc[stock, 'hamount'] = t_amount.loc[stock, 'tamount']
            h_amount.loc[stock, 'price'] = price
            h_amount.loc[stock, 'value'] = h_amount.loc[stock, 'price'] *\
                h_amount.loc[stock, 'hamount']

        h_amount['percent'] = h_amount['value'] / sum(h_amount['value'])

    # # Output holding details
    # h_amount.to_csv('position_details.csv')

    account.capital.append(today_capital)
    try:
        drawdown = (max(account.capital[:-1])-account.capital[-1]) /\
            max(account.capital[:-1])
    except Exception:
        drawdown = 0

    if drawdown > account.history_max:
        account.drawdown_start =\
            trade_days[account.capital.index(max(account.capital[:-1]))]
        account.drawdown_end =\
            trade_days[account.capital.index(account.capital[-1])]
        account.history_max = drawdown

    account.ret = account.ret.append(pd.DataFrame(
        {'rev': (account.capital[-1]-account.capital[0])/account.capital[0],
         'max_drawdown': account.history_max,
         'benchmark':
         (account.benchmark_data.loc[date.strftime('%Y-%m-%d'), 'open'] -
          account.benchmark_data.loc[trade_days[0].strftime('%Y-%m-%d'),
                                     'open']) /
         account.benchmark_data.loc[trade_days[0].strftime('%Y-%m-%d'),
                                    'open']},
        index=[date]))


def order_pct_to(pct_target):
    """
    下单到多少百分比。
    """
    ini_dic = account.ini_dic
    today_capital = account.today_capital
    # target是存储目标股数的Series
    target = pd.Series()

    # 将pct_target中的仓位百分比数据转化为target中的股数
    for stock in list(pct_target.index):
        stock_data = ini_dic[stock].loc[date.strftime("%Y-%m-%d")]
        price = stock_data['open']
        # price = stock_data.loc[date.strftime('%Y-%m-%d'), 'open']
        # print("today_capital: ", today_capital)
        target[stock] = (pct_target[stock]*today_capital) / price

    print("pct_target: ", pct_target)
    print("target: ", target)
    # 调用order_to函数
    order_to(target)


def result_display(account):
    """
    Display results, including the return curve and a table showing returns
    drawdown and drawdown intervals.
    """
    # account.ret.to_csv('return_details.csv')
    # strategy annual return
    Ra = (1+(account.ret.iloc[-1].rev)) **\
        (12/len(list(account.trade_days))) - 1
    results = pd.DataFrame({'benchmark return':
                            '%.2f%%' % (account.ret.iloc[-1].benchmark * 100),
                            'Strategy return':
                            '%.2f%%' % (account.ret.iloc[-1].rev * 100),
                            'Strategy annual return':
                            '%.2f%%' % (Ra*100),
                            'Max drawdown':
                            '%.2f%%' % (account.ret.iloc[-1].max_drawdown*100),
                            'Max drawdown interval':
                            str(account.drawdown_start.strftime('%Y-%m-%d')
                                + ' to '
                                + account.drawdown_end.strftime('%Y-%m-%d'))},
                           index=[''])
    results.reindex(['benchmark return',
                     'Strategy return',
                     'Strategy annual return',
                     'Max drawdown'
                     'Max drawdown interval'], axis=1)
    print(results.transpose())

    # plot the results
    account.ret['rev'].plot(color='royalblue', label='strategy return')
    account.ret['benchmark'].plot(color='black', label='benchmark return')
    x = np.array(list(account.ret.index))
    plt.fill_between(x, max(max(account.ret.rev), max(account.ret.benchmark)),
                     min(min(account.ret.rev), min(account.ret.benchmark)),
                     where=((x <= account.drawdown_end) &
                            (x >= account.drawdown_start)),
                     facecolor='lightsteelblue',
                     alpha=0.4)
    plt.legend()
    plt.show()


###############################################################################
#                   Parameters and functions set up manually                  #
###############################################################################


def initialize(account):
    """
    This is a function that runs only once, before the backtest begins.
    """
    pass


def stock_filter(account):
    """
    根据yoyop进行选股的函数。选yoyop前50的股票。
    """
    global selected
    # 将date这一交易日的股票数据取出存到一个新的dataframe中
    all_stock_df = pd.DataFrame()
    mktmaker_information = pd.read_csv(
        'market_maker_information1.csv', index_col="secid")
    amount_information = pd.read_csv(
        'amount_information1.csv', index_col="secid")
    # 遍历ini_dic中所有的股票
    for stock in list(account.ini_dic.keys()):
        # 将date这一天的数据存入all_stock_df中，去掉无数据的
        if mktmaker_information.loc[stock, date.strftime('%Y-%m-%d')] == 1 and\
           amount_information.loc[stock, date.strftime('%Y-%m-%d')] >= 1000000:
            try:
                all_stock_df = all_stock_df.append(
                    account.ini_dic[stock].loc[date.strftime('%Y-%m-%d')])
            except Exception:
                pass

    # 按yoyop降序排序
    all_stock_df = all_stock_df.sort_values('yoyop', ascending=False)
    # 取前50支股票
    selected_stock_df = all_stock_df[:5]
    # 将选取的股票代码存入buylist
    buylist = list(selected_stock_df['secid'])
    # 输出选股情况
    print(date.strftime('%Y-%m-%d'), "selected stocks: ", buylist)

    selected = selected.append(pd.DataFrame(
        {"selected stocks": str(buylist)}, index=[date.strftime('%Y-%m-%d')]))
    return buylist


def handle_data(account):
    """
    This is a function that runs every backtest frequency.
    """
    # selected_stocks为上述选股函数选出的函数
    selected_stocks = stock_filter(account)
    # print(selected_stocks)
    # positions为声明的一个存储目票仓位情况的Series
    positions = pd.Series()
    # 这里采用平均配仓的方式
    for stock in selected_stocks:
        positions[stock] = 1/len(selected_stocks)
        # 将仓位传入下单函数进行下单
    order_pct_to(positions)


for date in list(account.trade_days):
    account.today_capital = 0
    for stock in list(h_amount.index):
        try:
            stock_data = account.ini_dic[stock].loc[date.strftime(
                "%Y-%m-%d")].fillna(0)
            price = stock_data['open']
            account.today_capital += price * h_amount.loc[stock, 'hamount']
        except Exception:
            pass
    account.today_capital += account.cash

    print("cash: ", account.cash)
    print("today_capital: ", account.today_capital)
    handle_data(account)

selected.to_csv("with_selected_stocks_information5.csv")
result_display(account)
\end{lstlisting}

\begin{center}
\includegraphics[width=.9\linewidth]{/tmp/image.png}
\end{center}
\end{document}